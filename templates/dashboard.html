<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Centro de Comando</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Estilos espec√≠ficos do dashboard */
        .dashboard-container {
            width: 800px;
            background: #1a1a1a;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            color: #0f0;
            font-family: 'Courier New', Courier, monospace;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            padding-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            border-radius: 5px;
            transition: 0.2s;
        }
        .btn-single { background: #007bff; color: white; }
        .btn-single:hover { background: #0056b3; }
        
        .btn-stress { background: #dc3545; color: white; }
        .btn-stress:hover { background: #a71d2a; }
        
        .log-window {
            height: 300px;
            background: black;
            border: 1px solid #333;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.9rem;
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #222; padding-bottom: 2px;}
        .srv-8001 { color: #00c6ff; }
        .srv-8002 { color: #f7971e; }
        .srv-8003 { color: #38ef7d; }
        .srv-cache { color: #ffff00; font-weight: bold;}
        .srv-error { color: #ff0000; background: #300; }
    </style>
</head>
<body style="background: #121212;">

    <div class="dashboard-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2 style="margin:0; color: #00ff00;">
        üéõÔ∏è CONTROL CENTER DE <span style="color: white; text-transform: uppercase;">{{ username }}</span>
    </h2>
    <a href="/logout" style="color: #ff4444; text-decoration: none; font-weight: bold; border: 1px solid #ff4444; padding: 5px 10px; border-radius: 5px;">SAIR üö™</a>
</div>
        <div class="controls">
            <button class="btn-single" onclick="sendRequest()">Enviar 1 Requisi√ß√£o</button>
            <button class="btn-stress" onclick="toggleStress()">üî• MODO ESTRESSE (On/Off)</button>
            <div style="margin-left: auto; color: white;">
                Status: <span id="status-text">Aguardando...</span>
            </div>
        </div>

        <div class="log-window" id="logWindow">
            <div class="log-entry">Sistema iniciado. Pronto para testes.</div>
        </div>
    </div>

    <script>
        let stressInterval = null;

        async function sendRequest() {
            const logWin = document.getElementById('logWindow');
            const statusText = document.getElementById('status-text');
            
            try {
                const start = Date.now();
                // Faz a requisi√ß√£o para a raiz do Load Balancer
                const response = await fetch('/');
                const end = Date.now();
                
                // L√™ o cabe√ßalho personalizado que criamos no Python
                const serverId = response.headers.get('X-Server-ID');
                const status = response.status;
                
                // Cria a linha de log
                const div = document.createElement('div');
                div.className = 'log-entry';
                
                if (status === 200) {
                    let colorClass = '';
                    if (serverId === '8001') colorClass = 'srv-8001';
                    else if (serverId === '8002') colorClass = 'srv-8002';
                    else if (serverId === '8003') colorClass = 'srv-8003';
                    else if (serverId === 'CACHE') colorClass = 'srv-cache';
                    
                    div.innerHTML = `[${new Date().toLocaleTimeString()}] ‚úÖ Sucesso | <span class="${colorClass}">Servidor: ${serverId}</span> | Tempo: ${end-start}ms`;
                } else if (status === 429) {
                    div.innerHTML = `[${new Date().toLocaleTimeString()}] ‚õî <b>BLOQUEADO (429)</b> - Rate Limit Ativado!`;
                    div.className += ' srv-error';
                } else {
                    div.innerHTML = `[${new Date().toLocaleTimeString()}] ‚ùå Erro ${status}`;
                    div.className += ' srv-error';
                }

                logWin.insertBefore(div, logWin.firstChild); // Adiciona no topo
                statusText.innerText = "Requisi√ß√£o enviada";

            } catch (e) {
                console.error(e);
            }
        }

        function toggleStress() {
            const btn = document.querySelector('.btn-stress');
            if (stressInterval) {
                // Parar
                clearInterval(stressInterval);
                stressInterval = null;
                btn.innerText = "üî• MODO ESTRESSE (On/Off)";
                btn.style.opacity = "1";
                document.getElementById('status-text').innerText = "Parado.";
            } else {
                // Iniciar (Dispara a cada 200ms)
                stressInterval = setInterval(sendRequest, 200);
                btn.innerText = "‚èπ PARAR ATAQUE";
                btn.style.opacity = "0.8";
                document.getElementById('status-text').innerText = "ATAQUE EM ANDAMENTO!";
            }
        }
    </script>
</body>
</html>